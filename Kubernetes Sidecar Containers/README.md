# Kubernetes Sidecar Containers

We have a web server container running the nginx image. The access and error logs generated by the web server are not critical enough to be placed on a persistent volume. However, Nautilus developers need access to the last 24 hours of logs so that they can trace issues and bugs. Therefore, we need to ship the access and error logs for the web server to a log-aggregation service. Following the separation of concerns principle, we implement the Sidecar pattern by deploying a second container that ships the error and access logs from nginx. Nginx does one thing, and it does it well—serving web pages. The second container also specializes in its task—shipping logs. Since containers are running on the same Pod, we can use a shared emptyDir volume to read and write logs.  
- Create a pod named webserver.
- Create an emptyDir volume shared-logs.
- Create two containers from nginx and ubuntu images with latest tag only and remember to mention tag i.e nginx:latest, nginx container name should be nginx-container and ubuntu container name should be sidecar-container on webserver pod.
- Add command on sidecar-container "sh","-c","while true; do cat /var/log/nginx/access.log /var/log/nginx/error.log; sleep 30; done"
- Mount the volume shared-logs on both containers at location /var/log/nginx, all containers should be up and running.

Note: The kubectl utility on jump_host has been configured to work with the kubernetes cluster.



## 1. Reconnaissance on the server
`kubectl cluster-info`  
```console
Kubernetes master is running at https://kodekloud-control-plane:6443
KubeDNS is running at https://kodekloud-control-plane:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
```

`kubectl get all -o wide`  
```console
NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE   SELECTOR
service/kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   78m   <none>
```

`kubectl get ns`  
```console
NAME                 STATUS   AGE
default              Active   78m
kube-node-lease      Active   78m
kube-public          Active   78m
kube-system          Active   78m
local-path-storage   Active   78m
```

`kubectl get svc -o wide`  
```console
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE   SELECTOR
kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   79m   <none>
```

`kubectl get no -o wide`  
```console
NAME                      STATUS   ROLES                  AGE   VERSION                          INTERNAL-IP   EXTERNAL-IP   OS-IMAGE       KERNEL-VERSION   CONTAINER-RUNTIME
kodekloud-control-plane   Ready    control-plane,master   79m   v1.20.5-rc.0.18+c4af4684437b37   172.17.0.2    <none>        Ubuntu 20.10   5.4.0-1089-gcp   containerd://1.5.0-beta.0-69-gb3f240206
```

`kubectl get po`  
```console
No resources found in default namespace.
```

`kubectl get pv`  
```console
No resources found
```

`kubectl get pvc`  
```console
No resources found in default namespace.
```

`kubectl get deploy`  
```console
No resources found in default namespace.
```

`kubectl get secret`  
```console
NAME                  TYPE                                  DATA   AGE
default-token-hdbpl   kubernetes.io/service-account-token   3      79m
```


## 2. Create YAML file
`vi /tmp/webserver.yaml`  
```yaml
---
apiVersion: v1
kind: Pod
metadata:
  name: webserver
  labels:
    name: webserver
spec:
  volumes:
    - name: shared-logs
      emptyDir: {}
  containers:
    - name: nginx-container
      image: nginx:latest
      volumeMounts:
        - name: shared-logs
          mountPath: /var/log/nginx
    - name: sidecar-container
      image: ubuntu:latest
      command: ["sh","-c","while true; do cat /var/log/nginx/access.log /var/log/nginx/error.log; sleep 30; done"]
      volumeMounts:
        - name: shared-logs
          mountPath: /var/log/nginx
```


## 3. Run YAML file
`kubectl apply -f /tmp/webserver.yaml`  
```console
pod/webserver created
```

`kubectl get pods -o wide`  
```console
NAME        READY   STATUS    RESTARTS   AGE   IP           NODE                      NOMINATED NODE   READINESS GATES
webserver   2/2     Running   0          38s   10.244.0.5   kodekloud-control-plane   <none>           <none>
```

`kubectl describe pods`  
```console
Name:         webserver
Namespace:    default
Priority:     0
Node:         kodekloud-control-plane/172.17.0.2
Start Time:   Thu, 13 Oct 2022 06:52:20 +0000
Labels:       name=webserver
Annotations:  <none>
Status:       Running
IP:           10.244.0.5
IPs:
  IP:  10.244.0.5
Containers:
  nginx-container:
    Container ID:   containerd://7fa140814b39c76ced22155d0d7ffe9e175c129f459bc76a073df0ac16f4c9ec
    Image:          nginx:latest
    Image ID:       docker.io/library/nginx@sha256:2f770d2fe27bc85f68fd7fe6a63900ef7076bc703022fe81b980377fe3d27b70
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Thu, 13 Oct 2022 06:52:30 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/log/nginx from shared-logs (rw)
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-hdbpl (ro)
  sidecar-container:
    Container ID:  containerd://3654fe582fd8529a5399d0182eacb0bd6739c35d34007ba83db47bca4edac095
    Image:         ubuntu:latest
    Image ID:      docker.io/library/ubuntu@sha256:35fb073f9e56eb84041b0745cb714eff0f7b225ea9e024f703cab56aaa5c7720
    Port:          <none>
    Host Port:     <none>
    Command:
      sh
      -c
      while true; do cat /var/log/nginx/access.log /var/log/nginx/error.log; sleep 30; done
    State:          Running
      Started:      Thu, 13 Oct 2022 06:52:47 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/log/nginx from shared-logs (rw)
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-hdbpl (ro)
Conditions:
  Type              Status
  Initialized       True 
  Ready             True 
  ContainersReady   True 
  PodScheduled      True 
Volumes:
  shared-logs:
    Type:       EmptyDir (a temporary directory that shares a pod's lifetime)
    Medium:     
    SizeLimit:  <unset>
  default-token-hdbpl:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-hdbpl
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  <none>
Tolerations:     node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                 node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  51s   default-scheduler  Successfully assigned default/webserver to kodekloud-control-plane
  Normal  Pulling    50s   kubelet            Pulling image "nginx:latest"
  Normal  Pulled     42s   kubelet            Successfully pulled image "nginx:latest" in 8.76882747s
  Normal  Created    42s   kubelet            Created container nginx-container
  Normal  Started    41s   kubelet            Started container nginx-container
  Normal  Pulling    41s   kubelet            Pulling image "ubuntu:latest"
  Normal  Pulled     25s   kubelet            Successfully pulled image "ubuntu:latest" in 16.030345025s
  Normal  Created    25s   kubelet            Created container sidecar-container
  Normal  Started    24s   kubelet            Started container sidecar-container
```


## 4. Validate the task
### 4.1. Get a shell to the nginx-container
`kubectl exec -it webserver --container nginx-container -- bash`  
```console
root@webserver:/# cd /var/log/nginx
root@webserver:/var/log/nginx# ls -la
total 20
drwxrwxrwx 2 root root 4096 Oct 13 06:52 .
drwxr-xr-x 1 root root 4096 Oct  5 12:44 ..
-rw-r--r-- 1 root root  341 Oct 13 06:57 access.log
-rw-r--r-- 1 root root 2874 Oct 13 06:56 error.log
```

### 4.2. Check if Nginx running
`curl -Ik localhost`  
```console
HTTP/1.1 200 OK
Server: nginx/1.23.1
Date: Thu, 13 Oct 2022 06:57:30 GMT
Content-Type: text/html
Content-Length: 615
Last-Modified: Tue, 19 Jul 2022 14:05:27 GMT
Connection: keep-alive
ETag: "62d6ba27-267"
Accept-Ranges: bytes
```


### 4.3. Do an error in URI to cause an error in log
`curl -Ik http://localhost/dummy_uri`  
```console
HTTP/1.1 404 Not Found
Server: nginx/1.23.1
Date: Thu, 13 Oct 2022 07:06:37 GMT
Content-Type: text/html
Content-Length: 153
Connection: keep-alive
```

`cat error.log`  
```console
2022/10/13 06:52:30 [notice] 1#1: using the "epoll" event method
2022/10/13 06:52:30 [notice] 1#1: nginx/1.23.1
2022/10/13 06:52:30 [notice] 1#1: built by gcc 10.2.1 20210110 (Debian 10.2.1-6) 
2022/10/13 06:52:30 [notice] 1#1: OS: Linux 5.4.0-1089-gcp
2022/10/13 06:52:30 [notice] 1#1: getrlimit(RLIMIT_NOFILE): 1048576:1048576
2022/10/13 06:52:30 [notice] 1#1: start worker processes
2022/10/13 06:52:30 [notice] 1#1: start worker process 80
<...>
2022/10/13 06:56:45 [error] 81#81: *2 open() "/usr/share/nginx/html/dummy_uri" failed (2: No such file or directory), client: ::1, server: localhost, request: "GET /dummy_uri HTTP/1.1", host: "localhost"
```

### 4.4. Get a shell to the sidecar-container
`kubectl exec -it webserver --container sidecar-container -- bash`  
```console
root@webserver:/# cd /var/log/nginx
root@webserver:/var/log/nginx# ls -ls
total 8
4 -rw-r--r-- 1 root root  341 Oct 13 06:57 access.log
4 -rw-r--r-- 1 root root 2874 Oct 13 06:56 error.log
```

### 4.5. Check the same log file
`cat error.log`  
```console
2022/10/13 06:52:30 [notice] 1#1: using the "epoll" event method
2022/10/13 06:52:30 [notice] 1#1: nginx/1.23.1
2022/10/13 06:52:30 [notice] 1#1: built by gcc 10.2.1 20210110 (Debian 10.2.1-6) 
2022/10/13 06:52:30 [notice] 1#1: OS: Linux 5.4.0-1089-gcp
2022/10/13 06:52:30 [notice] 1#1: getrlimit(RLIMIT_NOFILE): 1048576:1048576
2022/10/13 06:52:30 [notice] 1#1: start worker processes
<...>
2022/10/13 06:56:45 [error] 81#81: *2 open() "/usr/share/nginx/html/dummy_uri" failed (2: No such file or directory), client: ::1, server: localhost, request: "GET /dummy_uri HTTP/1.1", host: "localhost"
```

---


```bash
CONGRATULATIONS!!!!
You have successfully completed the quiz. Results have been saved. Ref ID:63470177dc5b16e0c1151bb4
```
